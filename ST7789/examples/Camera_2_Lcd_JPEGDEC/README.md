# 双通道摄像头采集与显示系统

一个基于AMB82-MINI/BW21开发板的高性能双通道摄像头应用，实现VGA分辨率实时预览与720P高分辨率照片捕捉的并行处理。

## 🚀 项目概述

本项目利用RTL8735B芯片的硬件多通道能力，同时运行两个独立的视频流：
- **预览通道**：VGA分辨率（640x480）实时流畅显示在ST7789 TFT屏幕上
- **拍照通道**：720P分辨率（1280x720）按需抓拍并保存至SD卡

通过创新的"按需启停"架构，解决了常见的"VOE队列满"系统错误，在512KB RAM的有限资源下实现了高性能图像处理。

## 📋 功能特性

- **双通道并行处理**：预览与拍照独立通道，互不干扰
- **智能资源管理**：拍照通道按需启停，杜绝资源泄露
- **实时性能监控**：帧率与耗时统计，系统状态一目了然
- **DMA加速显示**：SPI DMA传输，最大化显示性能
- **自动定时拍照**：可配置间隔自动保存高清照片
- **SD卡存储**：高质量JPEG图像持久化保存

## 🛠️ 硬件要求

### 必需组件
| 组件 | 型号/规格 | 说明 |
|------|-----------|------|
| 开发板 | BW21-CBV-Kit 或 AMB82-MINI | 基于RTL8735B芯片 |
| 摄像头模组 | GC2053 (默认) | 支持多分辨率输出 |
| TFT显示屏 | ST7789 驱动 | 240x320分辨率，SPI接口 |
| SD卡模块 | SPI接口Micro SD卡槽 | 用于照片存储 |
| Micro SD卡 | FAT32格式 | 建议Class10以上速度 |

### 引脚连接
| 开发板引脚 | 连接目标 | 功能 |
|------------|----------|------|
| SPI_MOSI | TFT屏SDA | 显示数据 |
| SPI_MISO | (未使用) | - |
| SPI_SCLK | TFT屏SCL | 显示时钟 |
| SPI_SS | TFT屏CS | 片选 |
| PF_11 | TFT屏DC | 数据/命令选择 |
| PF_12 | TFT屏RESET | 复位 |
| PF_13 | TFT屏背光 | 背光控制 |
| SD卡模块 | 对应SPI引脚 | MOSI/MISO/SCK/CS |

## 🔧 软件配置

### 开发环境设置
1. **Arduino IDE配置**
   - 添加开发板支持URL：`https://github.com/ambiot/ambpro2_arduino/raw/master/Arduino_package/package_realtek.com_amebapro2_index.json`
   - 安装"AMB82-MINI"开发板支持包
   - 开发板选择："AMB82-MINI"

2. **库依赖安装**
   - 安装 `JPEGDEC` 库
   - 修改库配置：在 `User_Config.h` 中注释掉 `#define TJPGD_LOAD_SD_LIBRARY`
   - 确保已安装 `VideoStream`、`AmebaFatFS` 库（通常随SDK提供）

### 项目架构
```
Camera_2_Lcd_JPEGDEC/
├── Camera_2_Lcd_JPEGDEC.ino  # 主程序文件
├── AmebaST7789_DMA.h/cpp     # ST7789 DMA驱动
├── AmebaST7789.h/cpp         # ST7789基础驱动
├── font5x7.h                 # 字体文件
└── README.md                 # 本文档
```

## 📖 使用说明

### 快速开始
1. 按上述硬件要求连接所有组件
2. 将Micro SD卡格式化为FAT32格式
3. 在Arduino IDE中打开主程序文件
4. 选择正确的开发板和端口
5. 编译并上传程序

### 程序工作流程
```mermaid
graph TD
    A[系统启动] --> B[初始化外设<br/>显示屏/SD卡/摄像头];
    B --> C[开启预览通道<br/>VGA@30fps];
    C --> D{主循环开始};
    D --> E[获取预览帧];
    E --> F[DMA显示到屏幕];
    F --> G{到达拍照时间?};
    G -- 是 --> H[按需启停拍照流程];
    G -- 否 --> I[性能监控统计];
    H --> D;
    I --> D;
    
    subgraph H [拍照流程]
        H1[开启拍照通道] --> H2[传感器稳定120ms];
        H2 --> H3[捕获单帧720P];
        H3 --> H4[SD卡保存];
        H4 --> H5[关闭拍照通道];
    end
```

### 性能监控
程序每秒通过串口输出性能数据：
```
[状态] 预览FPS: 28, 平均每帧耗时: 35ms (注意：接近30fps极限)
```
- **理想状态**：FPS接近30，耗时≤33ms
- **警告状态**：耗时>33ms时显示提示，可能需要优化

## ⚙️ 参数配置

### 视频参数
| 参数 | 默认值 | 说明 | 可调整范围 |
|------|--------|------|-----------|
| 预览分辨率 | VIDEO_VGA | 640x480 | VIDEO_QVGA ~ VIDEO_VGA |
| 拍照分辨率 | VIDEO_HD | 1280x720 | VIDEO_HD ~ VIDEO_5M |
| 预览帧率 | CAM_FPS | 通常30fps | 10~30 |
| 拍照间隔 | 3000ms | 3秒自动拍照 | 1000~60000ms |
| JPEG缩放 | JPEG_SCALE_HALF | VGA半幅显示 | JPEG_SCALE_EIGHTH ~ JPEG_SCALE_HALF |

### 硬件参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| SPI频率 | 50MHz | 显示数据传输速率 |
| 背光引脚 | PF_13 | 高电平点亮 |
| 旋转方向 | 1 | 横屏显示 |

## 🔍 故障排除

### 常见问题

| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| **VOE队列满错误** | 1. 拍照通道常开<br>2. 主循环阻塞<br>3. SD卡操作耗时 | 1. 确保使用按需启停模式<br>2. 优化主循环代码<br>3. 分离SD卡操作 |
| **SD卡保存失败** | 1. 文件系统未初始化<br>2. 路径错误<br>3. 卡速太慢 | 1. 每次操作前调用fs.begin()<br>2. 检查getRootPath()返回值<br>3. 使用Class10以上SD卡 |
| **预览卡顿** | 1. 帧率设置过高<br>2. SPI频率不足<br>3. 解码耗时过长 | 1. 降低预览帧率至15fps<br>2. 确保SPI频率≥40MHz<br>3. 使用JPEG_SCALE_EIGHTH缩放 |
| **拍照无数据** | 1. 通道未正确开启<br>2. 稳定时间不足 | 1. 检查channelBegin调用<br>2. 增加delay至120ms以上 |

### 调试建议
1. **启用串口调试**：波特率115200，查看详细状态输出
2. **性能分析**：关注"平均每帧耗时"，确保小于帧间隔
3. **内存监控**：注意系统稳定性，512KB RAM是主要限制

## 📁 文件说明

### 核心文件
- **Camera_2_Lcd_JPEGDEC.ino**：主程序，包含双通道管理逻辑
- **AmebaST7789_DMA.h/cpp**：ST7789 DMA优化显示驱动
- **AmebaST7789.h/cpp**：ST7789基础驱动，包含初始化序列

### 关键函数
| 函数名 | 所在文件 | 功能描述 |
|--------|----------|----------|
| `captureHighResolutionPhoto()` | 主程序 | 按需拍照完整流程 |
| `saveToSDCard()` | 主程序 | SD卡存储实现 |
| `JPEGDraw()` | 主程序 | JPEG解码DMA回调 |
| `setRotation()` | AmebaST7789 | 屏幕方向设置 |
| `setColorOrder()` | AmebaST7789 | RGB/BGR模式切换 |

## 📈 性能优化建议

### 针对不同应用场景
1. **追求最高预览帧率**
   ```cpp
   // 降低预览分辨率
   VideoSetting configPreview(VIDEO_QVGA, 30, VIDEO_JPEG, 1);
   // 使用更快的解码缩放
   jpeg.decode(0, 0, JPEG_SCALE_EIGHTH);
   ```

2. **追求最佳拍照质量**
   ```cpp
   // 提高拍照分辨率（注意内存限制）
   VideoSetting configStill(VIDEO_FHD, 15, VIDEO_JPEG, 1);
   // 增加传感器稳定时间
   delay(150);
   ```

3. **平衡模式**（默认推荐）
   ```cpp
   // VGA预览 + 720P拍照
   // 3秒间隔，兼顾流畅性与画质
   ```

## 🧪 项目背景

本项目源于对AMB82-MINI/BW21开发板视频处理能力的深入探索。通过解决以下技术挑战：
1. **VOE队列溢出**：传统双通道常开模式导致系统不稳定
2. **内存限制**：512KB RAM下的高效图像处理
3. **实时性要求**：预览流畅与拍照画质的平衡

最终实现了创新的"按需启停"架构，为资源受限的嵌入式视觉应用提供了可靠解决方案。

## 📄 许可证

本项目基于Arduino开源生态构建，具体许可证请参考相关库文件的声明。

## 🤝 贡献与支持

欢迎提交Issue和Pull Request！对于硬件相关的问题，请提供：
1. 完整的串口调试输出
2. 硬件连接示意图
3. 复现步骤的详细描述

---
**项目状态**：稳定运行 ✅  
**最后测试**：2024年6月  
**适用硬件**：RTL8735B系列开发板  
**典型帧率**：预览28-30FPS，拍照延迟<500ms