# 模块化移植详细步骤

## 📋 **移植总览**
分**8个阶段**完成模块化移植，每个阶段都有明确的**成功验证标准**。

核心思维是逐步从Camera.ino里剥离代码，但每次都能将Camera.ino编译成功保持功能不变。
---

## 🎯 **阶段一：创建基础架构和共享模块**
**目标**: 建立模块化基础，不影响现有功能

### **步骤1.1 - 创建目录结构**
```
1. 创建空文件：
   examples/Camera/Shared_GlobalDefines.h
   examples/Camera/Shared_Types.h
   examples/Camera/Shared_SharedResources.h
```

### **步骤1.2 - 提取全局定义**
```
1. 打开Camera.ino，查找所有#define定义
2. 将以下内容移到GlobalDefines.h：
   - 引脚定义（TFT_CS、ENCODER_CLK等）
   - 颜色常量（ST7789_BLACK等）
   - 系统常量（BUTTON_DEBOUNCE_DELAY等）
3. 确保Camera.ino包含#include "Shared/GlobalDefines.h"
4. 注释掉Camera.ino中原有的#define（不删除，用于对比）
```

### **步骤1.3 - 创建基础类型**
```
1. 在Types.h中定义基础类型：
   - Point、Size、Rect结构体
   - SystemMode枚举（STATE_MAIN_MENU等）
   - TrianglePosition枚举（POS_A等）
2. 验证：编译无错误，系统正常运行
```

**✅ 阶段一成功标准**：
- 项目编译通过，无错误
- 系统启动正常，功能未受影响
- 所有宏定义已从Camera.ino移动到GlobalDefines.h

---

## 🎯 **阶段二：创建工具模块**
**目标**: 提取通用工具函数，减少主文件复杂度

### **步骤2.1 - 创建日志系统**
```
1. 创建examples/Camera/Utils_Logger.h/.cpp
2. 从Camera.ino提取Serial.print/println调用
3. 实现Logger类，提供error、info、debug等方法
4. 在Camera.ino中替换Serial调用为Logger调用
```
5. 确保日志输出格式保持一致
```

### **步骤2.2 - 创建定时器工具**
```
1. 创建examples/Camera/Utils_Timer.h/.cpp
2. 从Camera.ino提取millis()相关的时间处理逻辑
3. 实现Timer类，提供delayMs、getCurrentTime等方法
4. 创建Timeout类用于超时检测
```

### **步骤2.3 - 创建缓冲区管理器**
```
1. 创建examples/Camera/Utils_BufferManager.h/.cpp
2. 管理全局缓冲区（fontBuffer等）
3. 实现缓冲区的分配、释放和统计功能
```

**✅ 阶段二成功标准**：
- Logger正常工作，输出与Serial一致
- 所有时间相关功能正常（按钮消抖、延时等）
- 内存使用没有异常增加
- 系统编译通过，运行稳定

---

## 🎯 **阶段三：创建显示模块**
**目标**: 提取TFT和图形显示相关代码

### **步骤3.1 - 创建TFT管理器**
```
1. 创建examples/Camera/Display_TFTManager.h/.cpp
2. 从Camera.ino提取tft对象初始化代码
3. 移动tft.begin()、tft.fillScreen()等基本操作
4. 确保TFTManager类封装所有tft操作
5. 修改Camera.ino使用TFTManager实例
```

### **步骤3.2 - 创建字体渲染器**
```
1. 创建examples/Camera/Display_FontRenderer.h/.cpp
2. 从Camera.ino提取drawChineseChar、drawChineseString函数
3. 移动STR_REAL_TIME_PREVIEW等字符串常量
4. 移动font16x16.h引用和fontBuffer
5. 验证中文显示功能正常
```

### **步骤3.3 - 创建图形绘制模块**
```
1. 创建examples/Camera/Display_GraphicsPrimitives.h/.cpp
2. 从Camera.ino提取三角形相关函数：
   - adjustTrianglePosition()
   - clearTriangle()
   - updateTriangleDisplay()
   - moveTriangleToPosition()等
3. 移动triangleSizeValue等常量
4. 验证三角形移动和显示正常
```

**✅ 阶段三成功标准**：
- 屏幕显示正常，无花屏或闪烁
- 中文提示显示正确
- 三角形可以正常移动
- 菜单页面显示完整
- 系统响应速度无明显下降

---

## 🎯 **阶段四：创建编码器模块**
**目标**: 提取编码器驱动和中断处理

### **步骤4.1 - 创建编码器控制器**
```
1. 创建examples/Camera/Encoder_Control.h/.cpp
2. 从Camera.ino提取编码器引脚定义和初始化
3. 移动encoderCount、rotationDetected等变量
4. 创建EncoderControl类，封装所有编码器操作
5. 在Camera.ino中替换为EncoderControl实例
```

### **步骤4.2 - 提取中断处理函数**
```
1. 将encoderRotation_handler移动到EncoderControl类
2. 重构为静态成员函数或使用回调
3. 确保中断注册正常（digitalSetIrqHandler）
4. 测试编码器旋转事件正常触发
```

### **步骤4.3 - 创建事件分发机制**
```
1. 在EncoderControl中添加事件回调
2. 注册旋转和按钮事件处理函数
3. 确保事件传递到正确的处理模块
4. 测试编码器所有功能正常
```

**✅ 阶段四成功标准**：
- 编码器旋转正确移动三角形
- 按钮按下正常触发事件
- 消抖功能正常工作
- 无中断冲突或死锁
- 系统响应灵敏无延迟

---

## 🎯 **阶段五：创建相机模块**
**目标**: 提取相机相关功能，保持拍照预览正常

### **步骤5.1 - 创建相机核心驱动**
```
1. 创建examples/Camera/Camera_CameraCore.h/.cpp
2. 从Camera.ino提取相机初始化代码
3. 移动configPreview、configStill等配置
4. 封装Camera.videoInit()等Ameba SDK调用
5. 验证相机初始化成功
```

### **步骤5.2 - 创建预览管理器**
```
1. 创建examples/Camera/Camera_PreviewManager.h/.cpp
2. 从Camera.ino提取相机预览相关代码：
   - startCameraPreview()
   - exitCameraPreview()
   - handleCameraPreview()
3. 移动img_addr_preview等缓冲区变量
4. 测试实时预览功能正常
```

### **步骤5.2 - 创建拍照管理器**
```
1. 创建examples/Camera/Camera_PhotoCapture.h/.cpp
2. 从Camera.ino提取拍照相关代码：
   - captureAndSavePhoto()
   - savePhotoToSDCard()
3. 移动isCapturing、manualCaptureRequested等状态变量
4. 测试拍照保存功能正常
```

### **步骤5.3 - 创建SD卡管理器**
```
1. 创建examples/Camera/Camera_SDCardManager.h/.cpp
2. 从Camera.ino提取SD卡相关代码：
   - initSDCard()
   - savePhotoToSDCard()
3. 移动sdcardInitialized状态
4. 测试SD卡读写正常
```

**✅ 阶段五成功标准**：
- 相机初始化成功，无错误
- 实时预览流畅，帧率稳定
- 拍照功能正常，照片保存到SD卡
- 无内存泄漏或缓冲区溢出
- 拍照过程中可以正常退出

---

## 🎯 **阶段六：创建菜单模块**
**目标**: 提取菜单管理和状态机

### **步骤6.1 - 创建菜单管理器**
```
1. 创建examples/Camera/Menu_MenuManager.h/.cpp
2. 从Camera.ino提取菜单相关代码：
   - switchToMainMenu()
   - switchToSubMenu()
   - handleSubMenu()
3. 移动currentState等状态变量
4. 确保菜单切换功能正常
```

### **步骤6.2 - 创建三角形控制器**
```
1. 创建examples/Camera/Menu_TriangleController.h/.cpp
2. 整合GraphicsPrimitives中的三角形功能
3. 封装三角形位置管理逻辑
4. 确保三角形与菜单项联动正确
```

### **步骤6.3 - 创建菜单页面数据**
```
1. 创建examples/Camera/MenuPages.h
2. 移动MM.h、SM.h、ImageConfig.h的引用
3. 整理菜单页面数据结构
4. 确保菜单显示正常
```

**✅ 阶段六成功标准**：
- 主菜单和子菜单可以正常切换
- 三角形位置与菜单项正确对应
- 按钮在不同菜单状态下正确响应
- 菜单页面显示完整无缺失
- 状态切换无卡顿

---

## 🎯 **阶段七：创建FreeRTOS模块**
**目标**: 提取任务管理代码，建立真正的任务架构

### **步骤7.1 - 创建任务管理器**
```
1. 创建examples/Camera/RTOS_TaskManager.h/.cpp
2. 从Camera.ino提取任务管理代码：
   - initTaskManager()
   - createTask()
   - deleteTask()等函数
3. 移动taskManager数组和taskHandles
4. 确保任务创建和删除功能正常
```

### **步骤7.2 - 创建任务工厂和事件管理**
```
1. 创建examples/Camera/RTOS_TaskFactory.h/.cpp
2. 创建examples/Camera/RTOS_EventDispatcher.h/.cpp
3. 创建examples/Camera/RTOS_SemaphoreManager.h/.cpp
4. 移动xEventGroup、xTaskMessageQueue等
5. 移动xGlobalMutex等信号量
6. 测试事件和信号量机制正常工作
```

### **步骤7.3 - 重构任务函数**
```
1. 将taskCameraPreview等任务函数移动到RTOS模块
2. 确保任务参数传递正确
3. 测试每个任务可以独立运行和退出
4. 验证任务调度正常
```

**✅ 阶段七成功标准**：
- 6个任务可以独立创建和运行
- 任务间通信正常（事件、消息队列）
- 资源管理无冲突（信号量正常）
- 任务退出时可以正确清理资源
- 系统资源使用率正常（CPU、内存）

---

## 🎯 **阶段八：创建系统模块和最终集成**
**目标**: 完成系统架构，精简主程序

### **步骤8.1 - 创建系统状态管理器**
```
1. 创建examples/Camera/System_StateManager.h/.cpp
2. 统一管理所有系统状态变量
3. 实现状态切换和持久化
4. 测试状态机转换正常
```

### **步骤8.2 - 创建资源管理器**
```
1. 创建examples/Camera/System_ResourceManager.h/.cpp
2. 统一管理所有动态资源
3. 实现资源分配、释放和统计
4. 测试资源管理无泄漏
```

### **步骤8.3 - 创建配置管理器**
```
1. 创建examples/Camera/System_ConfigManager.h/.cpp
2. 管理系统配置项
3. 实现配置保存和加载
4. 测试配置持久化正常
```

### **步骤8.4 - 重构Camera.ino主程序**
```
1. 简化setup()函数，仅调用模块初始化
2. 简化loop()函数，仅处理高优先级事件
3. 移除所有已提取到模块的代码
4. 确保系统运行正常的情况下让主程序代码行数尽可能少
5. 将主程序里已经模块化的相关代码和对应注释删除
6. 测试系统完整功能
```

**✅ 阶段八成功标准**：
- Camera.ino主程序简洁（<100行）
- 所有功能模块正常工作
- 系统启动时间正常（无明显延迟）
- 内存使用稳定（无持续增长）
- 各模块接口清晰，耦合度低
- 编译通过，无警告错误

---

## 🧪 **最终验证测试清单**

### **功能测试**
- [ ] 编码器旋转移动三角形
- [ ] 按钮按下切换菜单/拍照
- [ ] 相机预览流畅运行
- [ ] 拍照保存到SD卡
- [ ] 菜单页面正常切换
- [ ] 任务创建和删除正常
- [ ] 系统状态切换正常

### **性能测试**
- [ ] 内存使用稳定（无泄漏）
- [ ] CPU使用率正常（<80%）
- [ ] 响应延迟可接受（<100ms）
- [ ] 帧率稳定（预览>15fps）
- [ ] 启动时间正常（<3秒）

### **健壮性测试**
- [ ] 异常退出后可以恢复
- [ ] SD卡移除/插入可以处理
- [ ] 长时间运行无崩溃
- [ ] 多任务切换无死锁
- [ ] 中断处理无冲突

### **代码质量**
- [ ] 编译零错误、零警告
- [ ] 模块接口清晰
- [ ] 注释完整
- [ ] 代码风格一致
- [ ] 无重复代码

按照这8个阶段逐步移植，每个阶段都有明确的验证标准，可以确保移植过程平稳，降低出错风险。每个阶段完成后都要充分测试，确保功能正常后再进入下一阶段。