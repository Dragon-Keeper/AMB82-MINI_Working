# ST7789 TFT LCD初始化资料

本文档基于STM32F103项目中的ST7789 3.2寸IPS TFT LCD驱动代码提取，为后续移植到Arduino框架下的BW21-CBV-Kit开发板使用。

## 硬件规格
- **LCD型号**: ST7789 3.2寸IPS TFT
- **分辨率**: 240x320像素
- **接口**: 4线SPI
- **颜色深度**: 16位RGB565

## GPIO引脚定义

### STM32F103引脚映射
```c
// LCD引脚定义
#define SPI_CS  PAout(12)    // 片选信号 PA12
#define SPI_SDI PCout(13)    // 数据输入 PC13  
#define SPI_SDI_RD PCin(13)  // SDA读取时作为输入 PC13
#define SPI_SDO PAin(11)     // 数据输出 PA11
#define SPI_RST PCout(15)    // 复位信号 PC15
#define SPI_SCK PCout(14)    // 时钟信号 PC14
#define SPI_DC PAout(15)     // 数据/命令选择 PA15
#define LCD_LED PAout(2)     // 背光控制 PA2
```

### 引脚功能说明
- **CS**: 片选信号，低电平有效
- **RST**: 硬件复位，低电平复位
- **DC**: 数据/命令选择（0=命令，1=数据）
- **SDI(MOSI)**: 主设备数据输出
- **SCK**: 串行时钟
- **SDO(MISO)**: 主设备数据输入（用于读取）
- **LED**: 背光控制

## SPI通信协议

### 写寄存器函数
```c
void LCD_WR_REG(u16 data)
{
    SPI_CS = 0;        // 片选使能
    SPI_DC = 0;        // 命令模式
    
    // 发送8位命令
    for(i=0; i<8; i++) {
        if (data & 0x80) SPI_SDI = 1;
        else SPI_SDI = 0;
        data <<= 1;
        SPI_SCK = 0;
        SPI_SCK = 1;
    }
    SPI_CS = 1;        // 片选禁用
}
```

### 写数据函数
```c
void LCD_WR_DATA(u16 data)
{
    SPI_CS = 0;        // 片选使能
    SPI_DC = 1;        // 数据模式
    
    // 发送8位数据
    for(i=0; i<8; i++) {
        if (data & 0x80) SPI_SDI = 1;
        else SPI_SDI = 0;
        data <<= 1;
        SPI_SCK = 0;
        SPI_SCK = 1;
    }
    SPI_CS = 1;        // 片选禁用
}
```

## ST7789初始化序列

### 完整的初始化代码
```c
void LCD_Init(void)
{
    // 硬件复位
    SPI_RST = 1;
    delay_ms(1);
    SPI_RST = 0;
    delay_ms(10);
    SPI_RST = 1;
    delay_ms(120);

    // ************* Start Initial Sequence **********//
    delay_ms(120);

    LCD_WR_REG(0x11);       // Sleep Out
    delay_ms(120);

    LCD_WR_REG(0x36);       // MADCTL: Memory Data Access Control
    LCD_WR_DATA(0x00);      // 默认方向设置

    LCD_WR_REG(0x3A);       // COLMOD: Interface Pixel Format
    LCD_WR_DATA(0x55);      // 16位/pixel (RGB565)

    // Porch Setting
    LCD_WR_REG(0xB2);
    LCD_WR_DATA(0x0C);
    LCD_WR_DATA(0x0C);
    LCD_WR_DATA(0x00);
    LCD_WR_DATA(0x33);
    LCD_WR_DATA(0x33);

    // Gate Control
    LCD_WR_REG(0xB7);
    LCD_WR_DATA(0x74);      // VGH=14.97V, VGL=-7.67V

    // VCOM Setting
    LCD_WR_REG(0xBB);
    LCD_WR_DATA(0x1F);

    // LCM Control
    LCD_WR_REG(0xC0);
    LCD_WR_DATA(0x2C);

    // VDV and VRH Command Enable
    LCD_WR_REG(0xC2);
    LCD_WR_DATA(0x01);

    // VRH Set
    LCD_WR_REG(0xC3);
    LCD_WR_DATA(0x10);

    // VDV Set
    LCD_WR_REG(0xC4);
    LCD_WR_DATA(0x20);

    // Frame Rate Control in Normal Mode
    LCD_WR_REG(0xC6);
    LCD_WR_DATA(0x0F);

    // Power Control 1
    LCD_WR_REG(0xD0);
    LCD_WR_DATA(0xA4);
    LCD_WR_DATA(0xA1);

    // Positive Voltage Gamma Control
    LCD_WR_REG(0xE0);
    LCD_WR_DATA(0xD0);
    LCD_WR_DATA(0x07);
    LCD_WR_DATA(0x0E);
    LCD_WR_DATA(0x0B);
    LCD_WR_DATA(0x0A);
    LCD_WR_DATA(0x14);
    LCD_WR_DATA(0x38);
    LCD_WR_DATA(0x33);
    LCD_WR_DATA(0x4F);
    LCD_WR_DATA(0x37);
    LCD_WR_DATA(0x16);
    LCD_WR_DATA(0x16);
    LCD_WR_DATA(0x2A);
    LCD_WR_DATA(0x2E);

    // Negative Voltage Gamma Control
    LCD_WR_REG(0xE1);
    LCD_WR_DATA(0xD0);
    LCD_WR_DATA(0x0B);
    LCD_WR_DATA(0x10);
    LCD_WR_DATA(0x08);
    LCD_WR_DATA(0x08);
    LCD_WR_DATA(0x06);
    LCD_WR_DATA(0x35);
    LCD_WR_DATA(0x54);
    LCD_WR_DATA(0x4D);
    LCD_WR_DATA(0x0A);
    LCD_WR_DATA(0x14);
    LCD_WR_DATA(0x14);
    LCD_WR_DATA(0x2C);
    LCD_WR_DATA(0x2F);

    // Set Image Function
    LCD_WR_REG(0xE9);
    LCD_WR_DATA(0x11);
    LCD_WR_DATA(0x11);
    LCD_WR_DATA(0x03);

    LCD_WR_REG(0x21);       // Display Inversion On
    LCD_WR_REG(0x29);       // Display On
}
```

## 显示方向配置

### 方向控制寄存器 (0x36)
```c
void LCD_Display_Dir(u8 dir)
{
    if(dir==0||dir==1) {    // 竖屏
        lcddev.dir = 0;
        lcddev.width = 240;
        lcddev.height = 320;
        
        lcddev.wramcmd = 0x2C;  // 写RAM命令
        lcddev.setxcmd = 0x2A;  // 设置X坐标命令
        lcddev.setycmd = 0x2B;  // 设置Y坐标命令
        
        if(dir==0) {        // 0度旋转
            LCD_WR_REG(0x36);
            LCD_WR_DATA((0<<3)|(0<<7)|(0<<6)|(0<<5));
        } else {            // 180度旋转
            LCD_WR_REG(0x36);
            LCD_WR_DATA((0<<3)|(1<<7)|(1<<6)|(0<<5));
        }
    } else if(dir==2||dir==3) { // 横屏
        lcddev.dir = 1;
        lcddev.width = 320;
        lcddev.height = 240;
        
        lcddev.wramcmd = 0x2C;
        lcddev.setxcmd = 0x2A;
        lcddev.setycmd = 0x2B;
        
        if(dir==2) {        // 270度旋转
            LCD_WR_REG(0x36);
            LCD_WR_DATA((0<<3)|(1<<7)|(0<<6)|(1<<5));
        } else {            // 90度旋转
            LCD_WR_REG(0x36);
            LCD_WR_DATA((0<<3)|(0<<7)|(1<<6)|(1<<5));
        }
    }
}
```

## 颜色定义

### 16位RGB565颜色值
```c
#define WHITE         0xFFFF
#define BLACK         0x0000
#define BLUE          0x001F
#define BRED          0xF81F
#define GRED          0xFFE0
#define GBLUE         0x07FF
#define RED           0xF800
#define MAGENTA       0xF81F
#define GREEN         0x07E0
#define CYAN          0x7FFF
#define YELLOW        0xFFE0
#define BROWN         0xBC40     // 棕色
#define BRRED         0xFC07     // 棕红色
#define GRAY          0x8430     // 灰色
#define DARKBLUE      0x01CF     // 深蓝色
#define LIGHTBLUE     0x7D7C     // 浅蓝色
#define GRAYBLUE      0x5458     // 灰蓝色
#define LIGHTGREEN    0x841F     // 浅绿色
#define LGRAY         0xC618     // 浅灰色
#define LGRAYBLUE     0xA651     // 浅灰蓝色
#define LBBLUE        0x2B12     // 浅棕蓝色
```

## 关键命令说明

### 常用命令寄存器
- **0x11**: Sleep Out (退出睡眠模式)
- **0x29**: Display On (开启显示)
- **0x28**: Display Off (关闭显示)
- **0x2A**: Column Address Set (设置列地址)
- **0x2B**: Page Address Set (设置页地址)
- **0x2C**: Memory Write (内存写)
- **0x36**: MADCTL (内存访问控制)
- **0x3A**: COLMOD (接口像素格式)

### 内存访问控制位 (0x36寄存器)
- **Bit 7 (MY)**: 行地址顺序 (0=从上到下，1=从下到上)
- **Bit 6 (MX)**: 列地址顺序 (0=从左到右，1=从右到左)
- **Bit 5 (MV)**: 行列交换 (0=正常，1=行列交换)
- **Bit 3 (ML)**: 垂直刷新顺序
- **Bit 2 (MH)**: 水平刷新顺序

## 移植到Arduino的注意事项

1. **GPIO映射**: 需要根据BW21-CBV-Kit开发板的引脚布局重新映射GPIO
2. **SPI配置**: Arduino使用硬件SPI或软件SPI，需要相应配置
3. **时序调整**: 不同MCU的时钟速度可能不同，需要调整延时
4. **电源管理**: 注意背光控制和电源时序
5. **内存管理**: Arduino的内存资源有限，需要优化显示缓冲区

## 参考代码结构

移植时可参考以下函数结构：
- `LCD_Init()` - 初始化函数
- `LCD_WR_REG()` - 写寄存器
- `LCD_WR_DATA()` - 写数据
- `LCD_SetCursor()` - 设置光标位置
- `LCD_Fill()` - 填充区域
- `LCD_DrawPoint()` - 画点
- `LCD_ShowChar()` - 显示字符
- `LCD_ShowString()` - 显示字符串

此文档提供了完整的ST7789初始化资料，可直接用于Arduino框架下的移植工作。